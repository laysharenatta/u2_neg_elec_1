<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Honey Pop â€“ Movimientos</title>

    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            margin: 0;
            background: #ff66b3;
            color: white;
        }

        header {
            background: #ff4fa3;
            padding: 18px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        header h1 {
            margin: 0;
            font-size: 22px;
        }

        header button {
            background: #ff9f1c;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .panel {
            background: #0f172a;
            border-radius: 18px;
            padding: 22px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.35);
            margin-bottom: 20px;
        }

        h2 {
            margin-top: 0;
            color: #ff66b3;
        }

        select,
        input {
            background: #1e293b;
            border: none;
            padding: 10px;
            border-radius: 10px;
            color: white;
            margin-right: 10px;
            outline: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            color: #ff66b3;
            padding-bottom: 10px;
        }

        td {
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            font-size: 14px;
        }

        .entrada {
            color: #22c55e;
            font-weight: bold;
        }

        .salida {
            color: #ef4444;
            font-weight: bold;
        }

        .ajuste {
            color: #ff9f1c;
            font-weight: bold;
        }

        .badge {
            background: #ff9f1c;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            color: black;
        }

        .stock-bajo {
            background: rgba(239, 68, 68, 0.15);
        }

        .alerta {
            background: #ef4444;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .badge {
            background: #ff9f1c;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            color: black;
        }
    </style>
</head>

<body>

    <header>
        <h1>ðŸ“¦ Honey Pop â€“ Historial de Movimientos</h1>
        <button>Volver</button>
    </header>

    <div class="container">

        <!-- FILTROS -->
        <div class="panel">
            <h2>Filtros</h2>

            <select id="filtroProducto" onchange="renderTabla()">
                <option value="">Todos los productos</option>
                <option value="Mini Hokeis">Mini Hokeis</option>
                <option value="Choco Fresas">Choco Fresas</option>
                <option value="Gommy Ice">Gommy Ice</option>
                <option value="Fresas Pop">Fresas Pop</option>
                <option value="Waffle">Waffle</option>
                <option value="Frosty Cuki">Frosty Cuki</option>
                <option value="Agua de MazapÃ¡n">Agua de MazapÃ¡n</option>
                <option value="Paleta MonchÃ­sima">Paleta MonchÃ­sima</option>
            </select>

            <select id="filtroTipo" onchange="renderTabla()">
                <option value="">Todos los movimientos</option>
                <option value="Entrada">Entradas</option>
                <option value="Salida">Salidas</option>
                <option value="Ajuste">Ajustes</option>
            </select>
        </div>

        <!-- TABLA -->
        <div class="panel">
            <h2>Movimientos Registrados</h2>

            <table>
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Tipo</th>
                        <th>Cantidad</th>
                        <th>Fecha</th>
                        <th>Detalle</th>
                    </tr>
                </thead>
                <tbody id="tablaMovimientos"></tbody>
            </table>
        </div>

    </div>

    <script>
        const API = "http://127.0.0.1:8000/api";
        const STOCK_BAJO = 10;

        let movimientos = [];
        let productos = {};

        document.addEventListener("DOMContentLoaded", init);

        async function init() {
            await cargarProductos();
            await cargarMovimientos();
            renderTabla();
        }

        async function cargarProductos() {
            const res = await fetch(`${API}/productos`);
            const data = await res.json();

            productos = {};
            const select = document.getElementById("filtroProducto");

            data.forEach(p => {
                productos[p.id] = p.nombre;

                select.innerHTML += `<option value="${p.id}">${p.nombre}</option>`;
            });
        }

        async function cargarMovimientos() {
            const res = await fetch(`${API}/movimientos`);
            movimientos = await res.json();
        }

        function calcularStock() {
            const stock = {};

            movimientos.forEach(m => {
                const nombreProducto = productos[m.producto_id];
                if (!nombreProducto) return;

                if (!stock[nombreProducto]) stock[nombreProducto] = 0;

                if (m.tipo === "Entrada") stock[nombreProducto] += m.cantidad;
                if (m.tipo === "Salida") stock[nombreProducto] -= m.cantidad;
                if (m.tipo === "Ajuste") stock[nombreProducto] += m.cantidad;
            });

            return stock;
        }

        function renderTabla() {
            const productoFiltro = document.getElementById("filtroProducto").value;
            const tipoFiltro = document.getElementById("filtroTipo").value;

            const tabla = document.getElementById("tablaMovimientos");
            tabla.innerHTML = "";

            const stock = calcularStock();

            movimientos
                .filter(m => !productoFiltro || m.producto_id == productoFiltro)
                .filter(m => !tipoFiltro || m.tipo === tipoFiltro)
                .forEach(m => {

                    const nombreProducto = productos[m.producto_id] ?? "Producto";

                    let claseTipo = "";
                    if (m.tipo === "Entrada") claseTipo = "entrada";
                    if (m.tipo === "Salida") claseTipo = "salida";
                    if (m.tipo === "Ajuste") claseTipo = "ajuste";

                    const stockActual = stock[nombreProducto] ?? 0;
                    const stockBajo = stockActual < STOCK_BAJO;

                    tabla.innerHTML += `
                    <tr class="${stockBajo ? 'stock-bajo' : ''}">
                        <td>${nombreProducto}</td>
                        <td class="${claseTipo}">${m.tipo}</td>
                        <td>${m.cantidad}</td>
                        <td>${m.fecha}</td>
                        <td>
                            ${stockBajo
                            ? '<span class="alerta">âš  Stock Bajo (' + stockActual + ')</span>'
                            : '<span class="badge">' + (m.detalle ?? '') + '</span>'
                        }
                        </td>
                    </tr>
                `;
                });
        }
    </script>

</body>

</html>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Historial del Cliente</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      background: #f5f5f5;
    }

    h2 {
      text-align: center;
    }

    form {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 0 8px gray;
    }

    textarea, select, input {
      width: 100%;
      margin-top: 8px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    button {
      margin-top: 15px;
      padding: 10px;
      width: 100%;
      border: none;
      border-radius: 10px;
      background: black;
      color: white;
      cursor: pointer;
    }

    .timeline {
      border-left: 4px solid black;
      padding-left: 20px;
    }

    .evento {
      background: white;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 12px;
      box-shadow: 0 0 5px gray;
    }

    .tipo {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 8px;
    }

    .fecha {
      font-size: 12px;
      color: gray;
    }

    #resumenCliente {
      background: white;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 0 6px gray;
    }
  </style>
</head>

<body>

  <h2 id="tituloCliente">üìå Historial del Cliente</h2>

  <!-- ‚úÖ SELECTOR CLIENTES -->
  <label><strong>Seleccionar cliente:</strong></label>
  <select id="clienteSelect"></select>

  <br><br>

  <!-- ‚úÖ FORMULARIO -->
  <form id="formInteraccion">
    <h3>Registrar nueva interacci√≥n</h3>

    <label>Tipo:</label>
    <select id="tipo">
      <option value="llamada">Llamada</option>
      <option value="correo">Correo</option>
      <option value="reunion">Reuni√≥n</option>
    </select>

    <label>Descripci√≥n:</label>
    <textarea id="descripcion" required></textarea>

    <label>Fecha:</label>
    <input type="datetime-local" id="fecha" required>

    <button type="submit">Guardar interacci√≥n</button>
  </form>

  <!-- ‚úÖ RESUMEN CRM -->
  <div id="resumenCliente"></div>

  <!-- ‚úÖ FILTRO -->
  <label><strong>Filtrar por tipo:</strong></label>
  <select id="filtroTipo">
    <option value="todos">Todas</option>
    <option value="llamada">Llamadas</option>
    <option value="correo">Correos</option>
    <option value="reunion">Reuniones</option>
  </select>

  <br><br>

  <!-- ‚úÖ TIMELINE -->
  <h3>üïí L√≠nea de tiempo</h3>
  <div class="timeline" id="timeline"></div>


  <!-- ‚úÖ SCRIPT -->
  <script>
    let clienteID = null;

    // ‚úÖ Cargar lista de clientes
    async function cargarClientes() {
      const res = await fetch("http://127.0.0.1:8000/api/clients");
      const clientes = await res.json();

      const select = document.getElementById("clienteSelect");
      select.innerHTML = "<option value=''>-- Selecciona un cliente --</option>";

      clientes.forEach(c => {
        select.innerHTML += `
          <option value="${c.id}">
            ${c.nombre} (${c.correo})
          </option>
        `;
      });
    }

    // ‚úÖ Cargar historial del cliente seleccionado
    async function cargarHistorial() {
      if (!clienteID) return;

      const res = await fetch(
        `http://127.0.0.1:8000/api/clientes/${clienteID}/interacciones`
      );

      const data = await res.json();

      // Mostrar t√≠tulo cliente
      document.getElementById("tituloCliente").innerText =
        "üìå Historial de: " + data.cliente;

      // Total interacciones
      let total = data.interacciones.length;

      // Estado CRM simple
      let estado =
        total > 0 ? "Cliente en seguimiento activo ‚úÖ" : "Sin interacciones ‚ö†Ô∏è";

      // Mostrar resumen
      document.getElementById("resumenCliente").innerHTML = `
        <h3>üìä Resumen CRM</h3>
        <p><strong>Total de interacciones:</strong> ${total}</p>
        <p><strong>Estado:</strong> ${estado}</p>
      `;

      // Timeline
      const timeline = document.getElementById("timeline");
      timeline.innerHTML = "";

      // Filtro
      const filtro = document.getElementById("filtroTipo").value;

      data.interacciones
        .filter(i => filtro === "todos" || i.tipo === filtro)
        .forEach(i => {

          let icono = "";
          if (i.tipo === "llamada") icono = "üìû";
          if (i.tipo === "correo") icono = "üìß";
          if (i.tipo === "reunion") icono = "ü§ù";

          timeline.innerHTML += `
            <div class="evento">
              <div class="tipo">${icono} ${i.tipo.toUpperCase()}</div>
              <p>${i.descripcion}</p>
              <div class="fecha">üóì ${i.fecha}</div>
            </div>
          `;
        });
    }

    // ‚úÖ Seleccionar cliente
    document.getElementById("clienteSelect").addEventListener("change", e => {
      clienteID = e.target.value;

      if (clienteID) {
        cargarHistorial();
      }
    });

    // ‚úÖ Guardar interacci√≥n
    document.getElementById("formInteraccion").addEventListener("submit", async e => {
      e.preventDefault();

      if (!clienteID) {
        alert("‚ö†Ô∏è Selecciona un cliente primero");
        return;
      }

      await fetch("http://127.0.0.1:8000/api/interacciones", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          cliente_id: clienteID,
          tipo: document.getElementById("tipo").value,
          descripcion: document.getElementById("descripcion").value,
          fecha: document.getElementById("fecha").value
        })
      });

      alert("Interacci√≥n registrada ‚úÖ");

      document.getElementById("formInteraccion").reset();
      cargarHistorial();
    });

    // ‚úÖ Cambiar filtro tipo
    document.getElementById("filtroTipo").addEventListener("change", () => {
      cargarHistorial();
    });

    // ‚úÖ Inicializar todo
    cargarClientes();
  </script>

</body>
</html>
